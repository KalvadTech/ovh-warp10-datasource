{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","Warp10Datasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","lastErrors","options","backend","length","substr","method","data","headers","undefined","datasourceRequest","then","parseTemplatingResult","o","console","log","map","d","i","text","value","end","convertToWarp10Time","range","to","start","from","queries","each","targets","bind","target","expr","push","isEmpty","defer","resolve","promise","allQueryPromise","query","performTimeSeriesQuery","self","all","allResponse","result","response","index","isArray","warpscriptJsonResponse","metricData","transformMetricData","filter","replace","refId","hide","warpscriptScript","prepareWarpscriptQuery","endISO","convertToISO","startISO","interval","variables","variable","current","gts","isGts","className","c","labels","l","key","join","metricName","dps","v","Math","floor","datapoints","Array","splice","propertyIsEnumerable","a","date","parse","timestamp","Date","toISOString","roundUp","isMoment","isDate","time","mathString","parseString","substring","indexOf","ISO_8601","parseDateMath"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\r\nimport moment from 'moment';\r\n\r\nexport class Warp10Datasource {\r\n\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    this.type = instanceSettings.type;\r\n    this.url = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.lastErrors = {};\r\n  }\r\n\r\n  // Optional\r\n  // Required for templating\r\n  metricFindQuery(options) {\r\n    \r\n    var backend = this.url;\r\n    while (backend[backend.length-1] === '/') {\r\n      // remove trailing slash\r\n      backend = backend.substr(0, backend.length - 1);\r\n    }\r\n    var url = backend + '/api/v0/exec';\r\n\r\n    var options = {\r\n      method: 'POST',\r\n      url: url,\r\n      data: options,\r\n      headers: {\r\n          'Accept': undefined,\r\n          'Content-Type': undefined\r\n      }\r\n    };\r\n    return this.backendSrv.datasourceRequest(options).then(this.parseTemplatingResult);\r\n  }\r\n  parseTemplatingResult(o) {\r\n    console.log(o);\r\n     return _.map(o.data, (d, i) => {\r\n      return { text: d, value: i};\r\n    });\r\n  }\r\n\r\n  // Called once per panel (graph)\r\n  query(options) {\r\n\r\n    console.log(\"Query begin\");\r\n\r\n    var end = this.convertToWarp10Time(options.range.to);\r\n    var start = this.convertToWarp10Time(options.range.from);\r\n    \r\n    console.log(\"From: \"+start+ \" To: \"+end);\r\n\r\n\r\n    var queries = [];\r\n\r\n    console.log(\"Before foreach\");\r\n\r\n    _.each(options.targets, _.bind(function(target) {\r\n\r\n      console.log(\"Expre\", target.expr);\r\n      console.log(\"Backend URL\", target.backend);\r\n\r\n      queries.push(target);\r\n    }, this));\r\n\r\n    console.log(\"After foreach\");\r\n\r\n    // No valid targets, return the empty result to save a round trip.\r\n    if (_.isEmpty(queries)) {\r\n\r\n      console.log(\"Empty query\");\r\n\r\n      var d = this.q.defer();\r\n      d.resolve({ data: [] });\r\n      return d.promise;\r\n    }\r\n\r\n    var allQueryPromise = _.map(queries, _.bind(function(query) {\r\n      return this.performTimeSeriesQuery(query, start, end);\r\n    }, this));\r\n\r\n    var self = this;\r\n    return this.q.all(allQueryPromise)\r\n      .then(function(allResponse) {\r\n        var result = [];\r\n\r\n        _.each(allResponse, function(response, index) {\r\n\r\n          console.log(\"Response\", response);\r\n          if (response.data.type === 'error') {\r\n            self.lastErrors.query = response.data.value;\r\n            throw response.data.value;\r\n          }\r\n          delete self.lastErrors.query;\r\n\r\n          if (!self.isArray(response.data) || (response.data.length !== 1)) {\r\n            console.log(\"Response isn't an Array or it has more than 1 element\", response.data);\r\n            return {};\r\n          }\r\n\r\n          var warpscriptJsonResponse = response.data[0];\r\n\r\n          console.log(\"Response data\", warpscriptJsonResponse);\r\n\r\n          _.each(warpscriptJsonResponse, function(metricData) {\r\n            console.log(\"Metric data\",metricData);\r\n\r\n            result.push(self.transformMetricData(metricData, options.targets[index]));\r\n          });\r\n        });\r\n\r\n        return { data: result };\r\n      });\r\n  \r\n  }\r\n\r\n\r\n  buildQueryParameters(options) {\r\n    //remove placeholder targets\r\n    options.targets = _.filter(options.targets, target => {\r\n      return target.target !== 'select metric';\r\n    });\r\n\r\n    var targets = _.map(options.targets, target => {\r\n      return {\r\n        target: this.templateSrv.replace(target.target),\r\n        refId: target.refId,\r\n        hide: target.hide,\r\n        expr: target.expr,\r\n        backend: target.backend\r\n      };\r\n    });\r\n\r\n    options.targets = targets;\r\n\r\n    return options;\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Puts into the Warpscript script a header to place \r\n  /* start and end ont the stacks\r\n  /* ******************************************************/\r\n  performTimeSeriesQuery(query, start, end) {\r\n\r\n    var warpscriptScript = this.prepareWarpscriptQuery(query, start, end);\r\n\r\n    var backend = this.url;\r\n    // If we have defined a backend in the query editor, it takes preecedence\r\n    // over the datasource\r\n    if ((query.backend !== undefined) && (query.backend.length >0)) {\r\n      backend = query.backend;\r\n    }\r\n\r\n    while (backend[backend.length-1] === '/') {\r\n      // remove trailing slash\r\n      backend = backend.substr(0, backend.length - 1);\r\n    }\r\n\r\n    var url = backend + '/api/v0/exec';\r\n\r\n    var options = {\r\n      method: 'POST',\r\n      url: url,\r\n      data: warpscriptScript,\r\n      headers: {\r\n          'Accept': undefined,\r\n          'Content-Type': undefined\r\n      }\r\n    };\r\n\r\n\r\n    return this.backendSrv.datasourceRequest(options);\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Puts into the Warpscript script a header to place \r\n  /* start and end ont the stack\r\n  /* ******************************************************/\r\n  prepareWarpscriptQuery(query, start, end) {\r\n\r\n    var endISO = this.convertToISO(end);\r\n    var startISO = this.convertToISO(start);\r\n    var interval = end - start;\r\n\r\n    var warpscriptScript =\r\n          \" \" + start + \" 'start' STORE \" + end + \" 'end' STORE \" +\r\n          \"'\" + startISO + \"' 'startISO' STORE '\" + endISO + \"' 'endISO' STORE \" +\r\n          interval + \" 'interval' STORE\";\r\n    _.each(this.templateSrv.variables, function(variable) {\r\n      warpscriptScript += \"\\n'\" + variable.current.value + \"' '\"+variable.name+\"' STORE\";\r\n    });\r\n    if (query.expr !== undefined) {\r\n      warpscriptScript += \" \" + query.expr;\r\n    }\r\n    return warpscriptScript;\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Transform from Warpscript JSON to Grafana dps\r\n  /* ******************************************************/\r\n  transformMetricData(gts) {\r\n\r\n    if (!this.isGts(gts)) {\r\n      console.log(\"Response item isn't a gts\",gts);\r\n      return;\r\n    }\r\n\r\n    var className = gts.c;\r\n\r\n    var labels =\r\n      _.map(gts.l, function(value, key) {\r\n        return key+\"=\"+value;\r\n      }).join(\",\");\r\n\r\n    var metricName = className+\"{\"+labels+\"}\";\r\n    var dps = [];\r\n\r\n    _.each(gts.v, function(value) {\r\n      // Datapoint format: [ value, label]\r\n      dps.push([value[value.length -1], Math.floor(value[0]/1000)]);\r\n    });\r\n\r\n    // Metric format {target: \"Label text\", datapoints: [ datapoints objects] }\r\n\r\n    console.log({ target: metricName , datapoints: dps });\r\n    return { target: metricName, datapoints: dps };\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Returns true if @value is an Array\r\n  /* ******************************************************/\r\n  isArray(value) {\r\n    return value && typeof value === 'object' && value instanceof Array && typeof value.length === 'number'\r\n      && typeof value.splice === 'function' && !(value.propertyIsEnumerable('length'));\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Returns true if @gts is a JSON object version of a GTS\r\n  /* ******************************************************/\r\n  isGts(gts) {\r\n    if ((gts.c == null) || (gts.l == null) || (gts.a == null) || (gts.v == null)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Converts @date into µs since Epoch time \r\n  /* (Warpscript tick format) \r\n  /* ******************************************************/\r\n  convertToWarp10Time(date) {\r\n    date = this.parse(date);\r\n    return date * 1000;\r\n  }\r\n\r\n  /* ******************************************************/\r\n  /* Converts @timestamp into ISO 8601 format \r\n  /* ******************************************************/\r\n  convertToISO(timestamp) {\r\n    var date = new Date(Math.floor(timestamp/1000));\r\n    return date.toISOString();\r\n  }\r\n\r\n  parse(text, roundUp) {\r\n  if (!text) { return undefined; }\r\n  if (moment.isMoment(text)) { return text; }\r\n  if (_.isDate(text)) { return moment(text); }\r\n\r\n  var time;\r\n  var mathString = '';\r\n  var index;\r\n  var parseString;\r\n\r\n  if (text.substring(0, 3) === 'now') {\r\n    time = moment();\r\n    mathString = text.substring('now'.length);\r\n  } else {\r\n    index = text.indexOf('||');\r\n    if (index === -1) {\r\n      parseString = text;\r\n      mathString = ''; // nothing else\r\n    } else {\r\n      parseString = text.substring(0, index);\r\n      mathString = text.substring(index + 2);\r\n    }\r\n    // We're going to just require ISO8601 timestamps, k?\r\n    time = moment(parseString, moment.ISO_8601);\r\n  }\r\n\r\n  if (!mathString.length) {\r\n    return time;\r\n  }\r\n\r\n  return parseDateMath(mathString, time, roundUp);\r\n}\r\n\r\n}\r\n"]}